#!/bin/bash -e

echo "################################"
echo "Installing Shipyard to /usr/local/bin/shipyard"
echo ""
echo "Please note: You may be prompted for your password"
echo ""
echo "To remove Shipyard and all configuration use the command \"shipyard uninstall\""

# Determine the OS and architecure 
OS=$(uname)
ARCH=$(uname -m)
SHIPYARD_OS="linux"
SHIPYARD_ARCH=arm64"

if [ "${ARCH}" == "x86_64" ]; then
  SHIPYARD_ARCH="X86_64"
fi

if [ "${ARCH}" == "arm64" ]; then
  SHIPYARD_ARCH="arm64"
fi
  
if [ "${OS}" == "Linux" ]; then
  SHIPYARD_OS="linux"
fi
  
if [ "${OS}" == "Darwin" ]; then
  SHIPYARD_OS="darwin"
fi

version="$(curl -s https://shipyard.run/latest)"
binary="shipyard_${version}_${SHIPYARD_OS}_${SHIPYARD_ARCH}.tar.gz"

repo="https://github.com/shipyard-run/shipyard/releases/download/v${version}"

echo "Downloading $repo/$binary"
rm -f /tmp/shipyard.tar.gz
rm -f /tmp/shipyard

curl -L -s -o /tmp/shipyard.tar.gz "$repo/$binary"
cd /tmp

tar -xzf shipyard.tar.gz
rm shipyard.tar.gz

if which sudo; then
  sudo mv shipyard /usr/local/bin
  sudo chmod +x /usr/local/bin/shipyard
else
  # try without sudo might be running in a container
  mv shipyard /usr/local/bin
  chmod +x /usr/local/bin/shipyard
fi

echo ""
shipyard version
shipyard check
